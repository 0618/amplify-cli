version: 2.1

# this allows you to use CircleCI's dynamic configuration feature
setup: true

# the continuation orb is required in order to use dynamic configuration
orbs:
  continuation: circleci/continuation@0.1.2

executors:
  linux: &linux-e2e-executor
    docker:
      - image: public.ecr.aws/a6e6w2n0/amplify-cli-e2e-base-image-repo-public:latest
    working_directory: ~/repo
    resource_class: large
    environment:
      AMPLIFY_DIR: /home/circleci/repo/out
      AMPLIFY_PATH: /home/circleci/repo/out/amplify-pkg-linux

# our defined job, and its steps
jobs:
  setup:
    executor: 'linux'
    steps:
      - checkout # checkout code
      - run: # run a command
          name: Generate config
          command: |
            rm yarn.lock
            rm package.json
            npm init -f
            yarn add ts-node js-yaml fs-extra execa typescript glob @types/node @types/fs-extra @types/js-yaml @types/glob
            yarn ts-node --transpile-only ./scripts/split-e2e-tests.ts
      - continuation/continue:
          configuration_path: .circleci/generated_config.yml # use newly generated config to continue

# our single workflow, that triggers the setup job defined above
workflows:
  setup:
    jobs:
      - setup
